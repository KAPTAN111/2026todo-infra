name: Terraform DevSecOps Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  demo_job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ---------------- AZURE LOGIN (ADDED ONLY) ----------------
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ---------------- Terraform ----------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # ---------------- TFLINT ----------------
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: Run TFLint
        run: |
          tflint --init
          tflint

      # ---------------- TFSEC ----------------
      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3

      # ---------------- CHECKOV ----------------
      # - name: Run Checkov
      #   uses: bridgecrewio/checkov-action@master
      #   with:
      #     directory: .
      #     framework: terraform

      # ---------------- BIOME ----------------
      # - name: Setup Biome
      #   uses: biomejs/biome-github-action@v1
      #   with:
      #     version: 1.6.2

      # - name: Run Biome
      #   run: biome check .

      # ---------------- TERRAFORM EXECUTION ----------------
      - name: Terraform Init
        run: terraform init
        working-directory: ./environment/dev

      - name: Terraform Plan
        run: terraform plan
        working-directory: ./environment/dev

      - name: Terraform Apply (Manual Only)
        if: github.event_name == 'workflow_dispatch'
        run: terraform apply --auto-approve
        working-directory: ./environment/dev

      # ---------------- DEMO STEPS ----------------
      - name: Display Date and Time
        run: date

      - name: List Files
        run: ls -la

      - name: Print Hello World
        run: echo "Hello, World!"

      - name: Show System Information
        run: uname -a
